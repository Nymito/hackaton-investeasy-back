# üß† AI Market Analyst (Backend)

FastAPI backend that orchestrates **live** Mistral chat completions, Qdrant similarity search, scoring heuristics, PDF export and an optional n8n workflow to email the analysis.

## üöÄ Run locally

```bash
pip install -r requirements.txt
uvicorn main:app --reload
```

Then open üëâ http://127.0.0.1:8000/docs for the OpenAPI explorer.

## üîê Environment

Create a `.env` file (see `.env` for an example) and fill the following variables before hitting the API:

| Variable | Purpose |
|----------|---------|
| `MISTRAL_API_KEY` | API key used by `core.mistral_client` for all chat + embedding calls |
| `MISTRAL_EMBED_RPS` | Optional rate limit (requests per second) for embedding sync |
| `QDRANT_URL`, `QDRANT_API_KEY`, `QDRANT_COLLECTION` | Connection to your Qdrant cluster storing startup vectors |
| `STARTUP_DATASET_PATH` | CSV to ingest when syncing embeddings (defaults to `./unicorns till sep 2022.csv`) |
| `N8N_WEBHOOK_URL` | Optional webhook used by `/trigger-agent` to notify your n8n workflow |
| `STARTUP_SIMILARITY_VERBOSE` | Set to `1` to log similarity sync progress |

Restart Uvicorn whenever you update `.env`.

## üì¶ API surface

| Method | Route | Description |
|--------|-------|-------------|
| `GET` | `/` | Health check |
| `POST` | `/analyze` | Full live analysis (Mistral reasoning + competitors + profitability + Qdrant similarity + weighted score) |
| `POST` | `/analyze_mock` | Deterministic sample payload for demos when you need a quick response |
| `POST` | `/analysis/core` | Returns the raw core analysis (summary, positioning, profitability, target, score components) |
| `POST` | `/analysis/competitors` | Lists real competitors with strengths/weaknesses gathered via Mistral |
| `POST` | `/analysis/similar` | Retrieves similar startups from Qdrant for the provided idea |
| `POST` | `/analysis/score` | Recomputes the weighted score from custom score components |
| `POST` | `/trigger-agent` | Sends `{ idea, analysis, email }` to `N8N_WEBHOOK_URL` so n8n can take over (email, docs, etc.) |
| `POST` | `/export/pdf` | Generates a one-pager PDF from any `AnalyzeResponse` payload |

All routes expect/return the Pydantic models defined in `models.py`. The `/analyze` endpoint stitches together the outputs of the more granular `/analysis/*` routes so the frontend only needs a single call.

## üîé Similarity dataset

1. Place your CSV dataset (default: `unicorns till sep 2022.csv`) at the project root. Override with `STARTUP_DATASET_PATH` if needed.
2. Configure Qdrant credentials in `.env`: `QDRANT_URL`, `QDRANT_API_KEY`, optionally `QDRANT_COLLECTION`.
3. Sync the dataset vectors into Qdrant:

```bash
python -m core.startup_similarity  # uses Mistral embeddings + Qdrant
```

Once synced, `/analysis/similar` and `/analyze` pull nearest neighbors from Qdrant (cosine similarity).

## üîÅ n8n automation

Ship the analysis to the real world by plugging in n8n:

1. Start n8n (Docker `docker run -p 5678:5678 n8nio/n8n` or the desktop app), then import `spy_workflow.json` via **Import from File** and activate the workflow.
2. In the "Send email" node, configure your SMTP account (credential `SMTP account`).
3. Copy the webhook URL generated by n8n and set it in `.env`: `N8N_WEBHOOK_URL=https://.../webhook/...`. Restart FastAPI so it picks up the change.
4. From the frontend (or via `curl`), call `/trigger-agent` with `{ "idea": "...", "email": "...", "analysis": { ... } }`. The backend forwards that payload to n8n automatically.

The `/analyze` ‚Üí `/trigger-agent` duo lets the user read their live analysis and decide when to run the agent (email, doc generation, etc.).

```bash
curl -X POST http://127.0.0.1:8000/trigger-agent \
  -H 'Content-Type: application/json' \
  -d '{"idea": "Ghost kitchen platform", "email": "founder@example.com", "analysis": {"summary": "..."}}'
```

> ‚ÑπÔ∏è The workflow currently targets local usage. Make sure n8n and FastAPI run on the same machine (or network) before sharing the webhook.
